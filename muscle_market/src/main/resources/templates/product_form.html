<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isEditMode} ? '상품 수정' : '상품 등록'">상품 등록</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/header.css}" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f6f7;
            color: #333;
        }

        main.page-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 120px 20px 80px; /* 헤더 여백 포함 */
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        form {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 40px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        label {
            font-weight: 500;
            color: #444;
        }

        input, textarea, select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #F5C542;
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        input[type="file"] {
            border: none;
            padding-left: 0;
        }

        .preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }

        .preview img {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .submit-button {
            width: 100%;
            background-color: #F5C542;
            color: #333;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.25s ease, transform 0.05s ease;
        }

        .submit-button:hover {
            background-color: #d4a72e;
        }

        .submit-button:active {
            transform: scale(0.98);
        }

        /* 입력 필드 구분선 */
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 30px 0;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="page-content">
    <h2 th:if="${isEditMode}" th:text="|상품 수정: ${dto.title}|">상품 수정</h2>
    <h2 th:unless="${isEditMode}">상품 등록</h2>

    <form id="productForm">
        <div class="form-group">
            <label for="title">상품 제목</label>
            <input type="text" id="title" name="title"
                   th:value="${dto?.title}"
                   placeholder="상품 제목을 입력하세요" required>
        </div>

        <div class="form-group">
            <label for="description">상품 설명</label>
            <textarea id="description" name="description"
                      th:text="${dto?.description}"
                      placeholder="상품 설명을 입력하세요" required></textarea>
        </div>

        <input type="hidden" name="authorId" id="authorId">

        <div class="form-group">
            <label for="price">가격</label>
            <input type="number" id="price" name="price"
                   th:value="${dto?.price}"
                   placeholder="가격을 입력하세요" required>
        </div>

        <div class="form-group">
            <label for="location">거래 희망 위치</label>
            <input type="text" id="location" name="location"
                   th:value="${dto?.location}"
                   placeholder="예: 서울 강남구" required>
        </div>

        <div class="form-group">
            <label for="sportId">운동 종목 선택</label>
            <select id="sportId" name="sportId" required>
                <option value="">-- 종목을 선택하세요 --</option>
                <option th:each="sport : ${sports}"
                        th:value="${sport.id}"
                        th:text="${sport.name}"
                        th:selected="${dto?.sportName == sport.name}">헬스
                </option>
            </select>
        </div>
        <hr>

        <!--        이미지 업로드 방식 수정 예정-->
        <div class="form-group">
            <label for="images">상품 이미지 관리 (최대 5장)</label>

            <div th:if="${isEditMode}" id="currentImages" class="preview">
                <div th:each="url, iterStat : ${dto?.productImageUrls}"
                     class="image-container"
                     th:data-image-id="${dto?.productImageIds[__${iterStat.index}__]}">
                    <img th:src="${url}" alt="기존 이미지" onclick="toggleDelete(this)">
                </div>
                <hr>
            </div>

            <label>새 파일 추가</label>
            <input type="file" id="images" name="images" accept="image/*" multiple>

            <div class="preview" id="preview"></div>
        </div>

        <button class="submit-button" type="submit"
                th:text="${isEditMode} ? '수정 완료' : '등록하기'">등록하기
        </button>
    </form>
</main>

<!--로그인 사용자 정보 가져오기-->
<script th:inline="javascript">
    const currentUserId = [[${#authorization.expression('isAuthenticated()') ? #authentication.principal.id : null}]];
    const isEditMode = [[${isEditMode}]] || false;
    const currentProductId = isEditMode ? [[${productId}]] : null;

    let deletedImageIds = [];
    console.log("현재 로그인한 사용자 정보2:", currentUserId);
</script>
<script th:src="@{/js/header.js}" defer></script>
<script>
    // const sportSelect = document.getElementById('sportId');
    const form = document.getElementById('productForm');
    const imageInput = document.getElementById('images');
    // const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview');
    const currentImagesContainer = document.getElementById('currentImages');

    // csrf 토큰
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    async function loadSports() {
        try {
            const res = await fetch('/api/sports');
            if (!res.ok) throw new Error('스포츠 목록을 불러올 수 없습니다.');
            const sports = await res.json();
            sportSelect.innerHTML = '<option value="">-- 종목을 선택하세요 --</option>';
            sports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport.id;
                option.textContent = sport.name;
                sportSelect.appendChild(option);
            });
        } catch (err) {
            sportSelect.innerHTML = '<option value="">불러오기 실패</option>';
            console.error(err);
        }
    }

    // 이미지 업로드
    imageInput.addEventListener('change', () => {
        previewContainer.innerHTML = '';
        const files = Array.from(imageInput.files);
        if (files.length > 5) {
            alert('최대 5장까지만 업로드할 수 있습니다.');
            imageInput.value = '';
            return;
        }
        files.forEach(file => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            previewContainer.appendChild(img);
        });
    });

    // 기존 이미지 삭제
    function toggleDelete(imgElement) {
        const container = imgElement.parentNode;
        const imageId = container.dataset.imageId;

        if (container.classList.toggle('deleted')) {
            // 삭제 대기 추가
            if (imageId) deletedImageIds.push(parseInt(imageId));
            container.style.opacity = '0.4';
            container.style.border = '2px solid red';
        } else {
            // 삭제 대기 취소
            if (imageId) deletedImageIds = deletedImageIds.filter(id => id !== parseInt(imageId));
            container.style.opacity = '1';
            container.style.border = 'none';
        }
    }

    // 전송 버튼
    // 유효성 검사 추가
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = form.elements['title'].value.trim();
        const description = form.elements['description'].value.trim();
        const price = form.elements['price'].value.trim();
        const location = form.elements['location'].value.trim();
        const sportId = document.getElementById('sportId').value;
        const imageFiles = imageInput.files;

        // 이미지 검사 로직
        // 등록 시: 새 이미지 1개 이상
        // 수정 시: 기존 이미지|새 이미지 1개 이상
        const hasInitialImages = currentImagesContainer && currentImagesContainer.children.length > 0;
        const totalImagesAfterDelete = hasInitialImages ? currentImagesContainer.children.length - deletedImageIds.length : 0;

        const isImageRequired = !isEditMode || (isEditMode && totalImagesAfterDelete === 0 && imageFiles.length === 0);

        // 항목 유효성 검사
        if (!title || !description || !price || !location || !sportId) {
            alert('모든 필수 항목을 입력해 주세요.');
            return;
        }

        // 이미지 유효성 검사
        if (!isEditMode && imageFiles.length === 0) { // 등록 모드 & 파일 0개
            alert('최소 1개 이상의 이미지가 필요합니다.');
            return;
        }

        // 수정 시 모든 이미지를 지우고 새 이미지가 없을 경우
        if (isEditMode && (totalImagesAfterDelete + imageFiles.length) === 0) {
            alert('최소 1개 이상의 이미지가 필요합니다.');
            return;
        }

        if (!currentUserId) {
            alert('로그인 후 상품 등록이 가능합니다.');
            return;
        }

        document.getElementById('authorId').value = currentUserId;

        // dto
        // 수정 페이지를 위해 변ㄱ경
        const request = {
            title: form.elements['title'].value,
            description: form.elements['description'].value,
            price: parseFloat(form.elements['price'].value),
            location: form.elements['location'].value,
            sportId: parseInt(document.getElementById('sportId').value),
            authorId: currentUserId
        };

        // 수정 페이지에서만 이미지 id 추가
        const url = isEditMode ? `/api/products/${currentProductId}` : '/api/products';
        const method = isEditMode ? 'PUT' : 'POST';
        const imageKey = isEditMode ? 'newImages' : 'images';

        // 지워진 사진들 포함
        if (isEditMode) {
            request.deletedImageIds = deletedImageIds;
        }

        // 전송할 폼
        const formData = new FormData();
        // 폼에 텍스트 추가
        formData.append('request', new Blob([JSON.stringify(request)], {type: 'application/json'}));

        // 폼에 파일들 추가
        const files = Array.from(imageInput.files);
        files.forEach(file => formData.append(imageKey, file));

        // 요청
        const response = await fetch(url, {
            method: method,
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        });

        // 등록|수정
        if (response.ok || response.status === 303) {
            alert('상품이 ' + (isEditMode ? '수정' : '등록') + '되었습니다!');
            const locationHeader = response.headers.get('Location');

            // 등록 후 상세 페이지, 수정 후 해당 상품 상세 페이지로 이동
            if (locationHeader) {
                window.location.href = locationHeader;
            } else if (isEditMode) {
                window.location.href = `/products/${currentProductId}`;
            } else {
                window.location.href = '/products';
            }
        } else {
            alert('상품 처리 중 실패했습니다. (Status: ' + response.status + ')');
        }
    });

    loadSports();
</script>
</body>
</html>
