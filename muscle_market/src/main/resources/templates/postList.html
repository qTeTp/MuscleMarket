<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>전체 게시글</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (공통 스타일은 이전과 동일) */
        body {
            font-family: 'Montserrat', 'Pretendard', sans-serif;
            background-color: #f8f9fa;
        }
        .btn-secondary {
            background-color: #f1f3f5; border: 1px solid #dee2e6; color: #495057;
        }
        .btn-secondary:hover { background-color: #e9ecef; }
        .btn-outline {
            background-color: #ffffff; border: 1px solid #ced4da; color: #495057;
        }
        .btn-outline:hover { background-color: #f8f9fa; }
        .btn-primary {
            background-color: #3b82f6; color: white;
        }
        .btn-primary:hover { background-color: #2563eb; }
        .pagination-btn {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 2.25rem; height: 2.25rem; padding: 0 0.75rem;
            border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500;
            user-select: none; transition: background-color 0.2s;
        }
        .pagination-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active {
            background-color: #3b82f6; color: white; border-color: #3b82f6;
        }
        .pagination-btn.inactive {
            background-color: #ffffff; border: 1px solid #ced4da; color: #495057;
        }
        .pagination-btn.inactive:hover:not([disabled]) { background-color: #f8f9fa; }
    </style>
    <link th:href="@{/css/header.css}" rel="stylesheet"/>
</head>
<body class="bg-white">
    <div th:replace="~{fragments/header :: header}"></div>
    <main id="board-list" class="w-full max-w-6xl mx-auto px-4 pt-[90px] pb-10">
        <h1 class="text-3xl font-bold mb-6">전체 게시글</h1>

        <!-- 필터 및 검색 영역 -->
        <div class="flex justify-between items-center mb-4">
            <!-- 좌측 필터 -->
            <div class="flex items-center gap-4">
                <select id="filter-category" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- 운동 선택 --</option>
                </select>
                <div class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="meetup-only" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="meetup-only" class="cursor-pointer">번개</label>
                </div>
            </div>
            
            <!-- 우측 검색 -->
            <div class="relative">
                <input id="filter-search-input" type="text" placeholder="검색" class="border border-gray-300 rounded-md py-2 px-4 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" id="post-search-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 게시글 테이블 -->
        <div class="border-t-2 border-gray-800">
            <table class="w-full text-left">
                <thead class="border-b border-gray-300">
                    <tr class="text-sm text-gray-600">
                        <th class="py-3 px-2 w-16 text-center">No</th>
                        <th class="py-3 px-2">제목</th>
                        <th class="py-3 px-2 w-32">카테고리</th>
                        <th class="py-3 px-2 w-32">작성자</th>
                        <th class="py-3 px-2 w-32">등록일</th>
                        <th class="py-3 px-2 w-20 text-center">조회수</th>
                    </tr>
                </thead>
                <tbody id="post-table-body">
                    <!-- JS에 의해 동적으로 채워짐 -->
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div id="pagination-container" class="flex justify-center items-center gap-2 mt-8">
            <!-- JS에 의해 동적으로 채워짐 -->
        </div>

        <!-- 글쓰기 버튼 (링크 수정) -->
        <div class="flex justify-end gap-2 mt-6" id="new-post-btn">
            <a href="/posts/new" class="btn-outline px-4 py-2 rounded-md font-medium text-sm">게시글 작성</a>
        </div>
    </main>

    <script th:src="@{/js/header.js}" defer></script>
    <script>
        // 현재 로그인한 유저
        let currentUser = null;
        
        // CSRF Token
        const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute('content');
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute('content');

        // Pagination options
        const postsPerPage = 10; // 페이지 당 게시글 수 (size)
        const pageGroupSize = 10; // 한 번에 10개까지의 페이지만 보여주기

        // 요소 가져오기
        const postSearchInput = document.getElementById('filter-search-input');
        const postSearchBtn = document.getElementById('post-search-btn');
        const newPostBtn = document.getElementById('new-post-btn');
        const postSportFilterContainer = document.getElementById('filter-category');
        const bungaeCheckBox = document.getElementById('meetup-only');
        const postListContainer = document.getElementById('post-table-body');
        const paginationContainer = document.getElementById('pagination-container');

        // URL 패러미터에서 필터나 페이지 값 읽어오기
        function applyUrlParamsToFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            const sportId = escapeHtml(urlParams.get('sportId')) || '';
            const isBungae = escapeHtml(urlParams.get('isBungae')) === 'true';
            const keyword = escapeHtml(urlParams.get('keyword')) || '';

            if (postSportFilterContainer) postSportFilterContainer.value = sportId;
            if (bungaeCheckBox) bungaeCheckBox.checked = isBungae;
            if (postSearchInput) postSearchInput.value = keyword;
        }

        // 게시글 불러오기
        async function fetchPostList(page) {
            // 필터 읽기
            const sportId = postSportFilterContainer ? postSportFilterContainer.value : '';
            const isBungae = bungaeCheckBox ? bungaeCheckBox.checked : false;
            const keyword = postSearchInput ? postSearchInput.value.trim() : '';

            // API 호출 쿼리 생성
            const params = new URLSearchParams({
                page: page,
                size: postsPerPage,
                sort: 'postId,desc'
            });

            if (sportId) params.append('sportId', sportId);
            if (isBungae) params.append('isBungae', isBungae);
            if (keyword) params.append('keyword', escapeHtml(keyword));

            // url 상태 업데이트
            const stateUrl = `${window.location.pathname}?${params.toString()}`;
            if (window.location.search.substring(1) !== params.toString()) {
                history.pushState(null, '', stateUrl);
            }

            try {
                const res = await fetch(`/api/posts?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });

                if (!res.ok) {
                    throw new Error('게시글 불러오기 실패');
                }

                const pageData = await res.json();

                renderPosts(pageData);

                createPagination(
                    pageData,
                    (pageIndex) => fetchPostList(pageIndex)
                );
            } catch (error) {
                console.error(error.message);
                if (postListContainer) {
                    postListContainer.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-red-500">데이터 로드 실패</td></tr>';
                }
            }
        }

        // 게시글 렌더링
        function renderPosts(pageData) {
            if (!postListContainer) return;

            const posts = pageData.content;
            const totalElements = pageData.totalElements;
            const size = pageData.size;
            const pageNumber = pageData.pageable.pageNumber;

            postListContainer.innerHTML = '';

            if (posts.length === 0) {
                postListContainer.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">게시글이 없습니다.</td></tr>';
                return;
            }

            posts.forEach((post, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                // 상세 페이지 링크를 board-detail.html?id= 로 변경
                tr.innerHTML = `
                    <td class="py-4 px-2 text-center text-sm text-gray-700">${post.postId}</td>
                    <td class="py-4 px-2 font-medium">
                        <a href="/posts/${post.postId}" data-id="${post.postId}" class="hover:underline">
                            ${post.isBungae ? '<span class="text-xs font-bold text-red-500 mr-1">[번개]</span>' : ''}
                            ${escapeHtml(post.title)}
                        </a>
                    </td>
                    <td class="py-4 px-2 text-sm text-gray-700">${escapeHtml(post.sportName)}</td>
                    <td class="py-4 px-2 text-sm text-gray-700">${escapeHtml(post.authorNickname)}</td>
                    <td class="py-4 px-2 text-sm text-gray-700">${formatDate(post.createdAt)}</td>
                    <td class="py-4 px-2 text-center text-sm text-gray-700">${post.views}</td>
                `;
                postListContainer.appendChild(tr);
            });
        }

        // 페이지네이션 생성 함수
        function createPagination(pageData, onPageClick) {
            if (!paginationContainer) return;

            paginationContainer.innerHTML = '';
            const { totalPages, first, last } = pageData;
            const currentPage = pageData.pageable.pageNumber;

            if (totalPages === 0) return;

            const currentGroup = Math.floor(currentPage / pageGroupSize);
            const startPage = currentGroup * pageGroupSize + 1;
            const endPage = Math.min(startPage + pageGroupSize - 1, totalPages);

            const createButton = (text, pageIndex, isDisabled = false, classes = 'inactive') => {
                const button = document.createElement('button');
                button.innerText = text;
                button.className = `pagination-btn ${classes}`;
                button.disabled = isDisabled;
                button.addEventListener('click', () => onPageClick(pageIndex));
                return button;
            };

            // "이전 장" (◀◀)
            const prevGroupPage = (currentGroup - 1) * pageGroupSize;
            const prevGroupButton = createButton('◀◀', prevGroupPage, currentGroup === 0);
            paginationContainer.appendChild(prevGroupButton);
                
            // "이전" (개별)
            const prevPage = currentPage - 1;
            const prevButton = createButton('이전', prevPage, first);
            paginationContainer.appendChild(prevButton);

            // 페이지 번호 버튼
            for (let i = startPage; i <= endPage; i++) {
                const pageIndex = i - 1;
                const isActive = (pageIndex === currentPage);
                const button = createButton(i, pageIndex, false, isActive ? 'active' : 'inactive');
                paginationContainer.appendChild(button);
            }

            // "다음" (개별)
            const nextPage = currentPage + 1;
            const nextButton = createButton('다음', nextPage, last);
            paginationContainer.appendChild(nextButton);

            // "다음 장" (▶▶)
            const nextGroupPage = (currentGroup + 1) * pageGroupSize;
            const isLastGroup = endPage === totalPages;
            const nextGroupButton = createButton('▶▶', nextGroupPage, isLastGroup);
            paginationContainer.appendChild(nextGroupButton);
        }

        // 스포츠 카테고리 불러오기
        async function fetchSports() {
            try {
                const res = await fetch('/api/sports', {
                    method: 'GET',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (!res.ok) {
                    throw new Error('스포츠 리스트 불러오기 실패');
                }

                sports = await res.json();
                sports.forEach((sport) => {
                    const option = document.createElement('option');
                    option.value = sport.id;
                    option.textContent = sport.name;
                    postSportFilterContainer.appendChild(option);
                });
            } catch (error) {
                console.error(error.message);
            }
        }

        // 글쓰기 버튼 설정
        function setupCreatePostButton() {
            if (!newPostBtn) return;

            if (currentUser === null) {
                newPostBtn.classList.add('opacity-50', 'cursor-not-allowed');
                newPostBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('글을 작성하려면 로그인이 필요합니다');
                });
            } else {
                // 현재 상태를 보존하려 함
                const initialUrl = window.location.href;
                const encodedReturnUrl = encodeURIComponent(initialUrl);
                newPostBtn.href = `/posts/new?returnUrl=${encodedReturnUrl}`;
            }
        }

        // 현재 로그인한 유저 정보 가져오기
        async function fetchCurrentUserAndInit() {
            try {
                const res = await fetch('/api/users/me', {
                    method: 'GET',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (!res.ok) {
                    throw new Error('인증 실패. 로그인이 필요합니다.');
                }

                currentUser = await res.json();
                initializeApp();
            } catch (error) {
                console.error(error.message);
                // 로그인 페이지로 강제 이동
                window.location.href = "/login";
            }
        } 

        // 페이지 로드 될 때 실행되는 함수
        function initializeApp() {
            applyUrlParamsToFilters();

            const initialParams = new URLSearchParams(window.location.search);
            const initialPage = parseInt(initialParams.get('page')) || 0;
            // 2. 페이지네이션이 된 글 정보 가져오기
            fetchPostList(initialPage);
            // 3. 운동 목록 api로 불러오기
            fetchSports();
            // 4. 버튼들 이벤트 등록
            // 4-1. 카테고리 변경 시 즉시 조회
            if (postSportFilterContainer) {
                postSportFilterContainer.addEventListener('change', () => {
                    fetchPostList(0);
                });
            }
            // 4-2. 체크박스 변경 시 즉시 조회
            if (bungaeCheckBox) {
                bungaeCheckBox.addEventListener('change', () => {
                    fetchPostList(0);
                });
            }
            // 4-3. 검색 버튼 기능 추가 (검색어를 request에 담아서 다시 페이지네이션 함수 호출)
            if (postSearchBtn) {
                postSearchBtn.addEventListener('click', () => fetchPostList(0));
            }
            if (postSearchInput) {
                postSearchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') fetchPostList(0);
                });
            }
            // 4-3. 게시글 작성 버튼 기능 추가 (/posts/new로 리다이렉트, 단 로그인 유저만 허용)
            setupCreatePostButton();

            // 뒤로가기/앞으로가기 (브라우저 버튼) 감지
            window.addEventListener('popstate', (event) => {
                applyUrlParamsToFilters(); // URL이 바뀌었으니 필터 UI 다시 맞추기
                const params = new URLSearchParams(window.location.search);
                const page = parseInt(params.get('page')) || 0;
                fetchPostList(page); // 바뀐 URL의 page 값으로 데이터 다시 불러오기
            });
        }

        // XSS 공격 방지
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            if (!dateString) return '';
    
            const date = new Date(dateString);
    
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
    
            return `${year}년 ${month}월 ${day}일 ${hour}시 ${minute}분`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. 로그인 유저 정보 가져오고 다른 데이터 fetch
            fetchCurrentUserAndInit();
        });
    </script>
</body>
</html>